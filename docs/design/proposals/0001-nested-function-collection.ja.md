---
title: ネストした関数の収集
date: 2025-07-06
status: Approved
---

# 提案: ネストした関数の収集

## 動機
いくつかのプロジェクトでは構造化のためにネストした関数を多用している。しかし現在のコレクターはトップレベルの関数のみを記録するため、ネストしたルーチンを個別に解析することができない。

## 目的
- 一致の取りこぼしを防ぐため、デフォルトでネストした関数も収集する。
- トップレベルの関数だけを対象にしたい場合にオプトアウトできるようにする。

## 非目標
- 正規化されたAST生成の仕組みを変更すること。
- 異なるモジュール間でのネストした関数検出。

## 解決案
`FuncDeclaration` ノードをステートメント内までたどるようコレクターを拡張する。公開APIとCLIに `excludeNested` フラグを追加し、デフォルトではネストした関数を取得する。このフラグが指定された場合はネスト宣言を無視する。

## 代替案
- 既存のASTヘルパーを使わずに独自のビジターでソースを解析する案もあったが、単純さを優先して却下した。

## 影響とリスク
ネストした関数をデフォルトで収集すると大規模なコードベースではメモリ使用量が増える可能性がある。ただし `--exclude-nested` を用いることで緩和できる。

## 次のステップ
- ドキュメントとユニットテストを更新する。

